name: Deploy via SSM (Official AWS SDK)

on:
  push:
    branches: [ release ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deploy to EC2 via SSM
        id: ssm-deploy
        run: |
          aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "GitHub Actions Deploy" \
            --working-directory "/var/www/TradeInWeb" \
            --parameters '{"commands":["git checkout release && git pull origin release && npm install && npm run build && sudo cp -r build/* . && sudo chown -R www-data:www-data . && sudo systemctl restart nginx && echo \"Deployed at $(date)\""]}' \
            --output text \
            --query 'Command.CommandId'
          
          # Wait for command to complete (poll every 10s, up to 5 min)
          COMMAND_ID=$(aws ssm send-command --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" --document-name "AWS-RunShellScript" --parameters '{"commands":["echo \"Deployed at $(date)\""]}' --output text --query 'Command.CommandId')
          for i in {1..30}; do
            STATUS=$(aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "${{ secrets.EC2_INSTANCE_ID }}" --query 'Status' --output text)
            if [ "$STATUS" = "Success" ]; then
              echo "Command succeeded!"
              aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "${{ secrets.EC2_INSTANCE_ID }}" --query 'StandardOutputContent' --output text
              break
            elif [ "$STATUS" = "Failed" ]; then
              echo "Command failed!"
              aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "${{ secrets.EC2_INSTANCE_ID }}" --query 'StandardErrorContent' --output text
              exit 1
            fi
            sleep 10
          done
